<!DOCTYPE html>
<html lang="">
    <!-- title -->




<!-- keywords -->




<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="HackPluto">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="HackPluto">
    
    <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content>
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>ucore_lab0,lab1 · HackPluto&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href="/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href="/assets/favicon.ico">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/">HackPluto&#39;s Blog</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">ucore_lab0,lab1</a>
            </div>
    </div>
    
    <a class="home-link" href="/">HackPluto's Blog</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:50vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/2.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            ucore_lab0,lab1
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class="post-intro-tags">
    
        <a class="post-tag" href="javascript:void(0);" data-tags="ucore,lab0,lab1">ucore,lab0,lab1</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">8.5k</span>阅读时长: <span class="post-count reading-time">39 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2019/10/14</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h1 id="lab0"><a href="#lab0" class="headerlink" title="lab0"></a>lab0</h1><blockquote>
<p>之前对于Linux和汇编也有一些接触，所以实验报告里我只记录之前不太熟悉的内容</p>
</blockquote>
<h2 id="make和makefile"><a href="#make和makefile" class="headerlink" title="make和makefile"></a>make和makefile</h2><blockquote>
<p>在阅读实验指导书的同时，这里也记录我学习make的心得</p>
</blockquote>
<h3 id="makefile的规则"><a href="#makefile的规则" class="headerlink" title="makefile的规则"></a>makefile的规则</h3><blockquote>
<p>make命令是GNU的工程化编译工具，它用于编译大量互相关联的源代码，使用它可以实现项目的工程化管理，提高开发效率。</p>
</blockquote>
<blockquote>
<p>综上，编译链接的过程是：</p>
<ul>
<li>首先源文件会通过编译阶段生成中间目标文件，再由中间目标文件生成执行文件。</li>
<li>编译时编译器只检测程序的语法、函数，变量是否声明以及一些预处理。如果函数只是声明但是未实现则编译器只会警告(不是所有的编译器都是这样)，仍然可以生成中间目标文件。</li>
<li>在链接程序时，链接器会在所有的中间目标文件中寻找函数的实现，如果找不到，那就会提示链接错误。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target ... : prerequisites ...</span><br><span class="line">    command</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>target也就是一个目标文件，可以是Object 文件，也可以是执行文件。还可以是一个标签(Label)，对于标签这种特性，将在后面叙述。</li>
<li>prerequisites就是，要生成那个target所需要的文件或是目标。</li>
<li>command也就是make需要执行的命令。(任意的Shell命令)</li>
<li>这个规则可以这么看，目标文件target的生成需要依赖prerequisites中的一些文件，而target文件的生成规则是在command中定义的。</li>
</ul>
</blockquote>
<h2 id="基于硬件模拟器实现源码级调试"><a href="#基于硬件模拟器实现源码级调试" class="headerlink" title="基于硬件模拟器实现源码级调试"></a>基于硬件模拟器实现源码级调试</h2><h3 id="安装硬件模拟器QEMU"><a href="#安装硬件模拟器QEMU" class="headerlink" title="安装硬件模拟器QEMU"></a>安装硬件模拟器QEMU</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu-system</span><br></pre></td></tr></table></figure>
<h3 id="结合gdb和qemu源码级调试ucore"><a href="#结合gdb和qemu源码级调试ucore" class="headerlink" title="结合gdb和qemu源码级调试ucore"></a>结合gdb和qemu源码级调试ucore</h3><h4 id="ucore-代码编译"><a href="#ucore-代码编译" class="headerlink" title="ucore 代码编译"></a>ucore 代码编译</h4><p><img src="https://i.loli.net/2019/10/14/qVxXDBzwkQgAnWt.jpg" alt></p>
<p><img src="https://i.loli.net/2019/10/14/Zg2DCPsAriNzQj3.jpg" alt></p>
<ul>
<li>ucore.img：被qemu访问的虚拟硬盘文件</li>
<li>kernel: ELF格式的toy ucore kernel执行文，被嵌入到了ucore.img中</li>
<li>bootblock: 虚拟的硬盘主引导扇区（512字节），包含了</li>
<li>bootloader执行代码，被嵌入到了ucore.img中</li>
<li>sign：外部执行程序，用来生成虚拟的硬盘主引导扇区</li>
</ul>
<h4 id="使用远程调试"><a href="#使用远程调试" class="headerlink" title="使用远程调试"></a>使用远程调试</h4><blockquote>
<p>通过gdb可以对ucore代码进行调试，以lab1中调试memset函数为例：</p>
</blockquote>
<p>(1) 运行 qemu -S -s -hda ./bin/ucore.img -monitor stdio<br>(2) 运行 gdb并与qemu进行连接<br>(3) 设置断点并执行<br>(4) qemu 单步调试。</p>
<p><img src="https://i.loli.net/2019/10/14/p6jugHaFe41B2ti.jpg" alt></p>
<h4 id="使用gdb配置文件"><a href="#使用gdb配置文件" class="headerlink" title="使用gdb配置文件"></a>使用gdb配置文件</h4><blockquote>
<p>在lab1/tools目录下，执行完make后，我们可以创建文件gdbinit，并输入下面的内容：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">target remote <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1234</span></span><br><span class="line">file bin/kernel</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/10/14/8CEKwQBJbjMTXvF.jpg" alt></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -tui -x tools/gdbinit</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/10/14/slEj6kZFxzgar8A.jpg" alt></p>
<h1 id="lab1"><a href="#lab1" class="headerlink" title="lab1"></a>lab1</h1><h2 id="练习1：理解通过make生成执行文件的过程"><a href="#练习1：理解通过make生成执行文件的过程" class="headerlink" title="练习1：理解通过make生成执行文件的过程"></a>练习1：理解通过make生成执行文件的过程</h2><h3 id="操作系统镜像文件ucore-img是如何一步一步生成的？"><a href="#操作系统镜像文件ucore-img是如何一步一步生成的？" class="headerlink" title="操作系统镜像文件ucore.img是如何一步一步生成的？"></a>操作系统镜像文件ucore.img是如何一步一步生成的？</h3><blockquote>
<p>首先查看makefile文件</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">PROJ	:= challenge</span><br><span class="line">EMPTY	:=</span><br><span class="line">SPACE	:= $(EMPTY) $(EMPTY)</span><br><span class="line">SLASH	:= /</span><br><span class="line"></span><br><span class="line">V       := @</span><br><span class="line">#need llvm/cang<span class="number">-3.5</span>+</span><br><span class="line">#USELLVM := <span class="number">1</span></span><br><span class="line"># <span class="keyword">try</span> to infer the correct GCCPREFX</span><br><span class="line">ifndef GCCPREFIX</span><br><span class="line">GCCPREFIX := $(shell if i386-elf-objdump -i 2&gt;&amp;1 | grep '^elf32-i386$$' &gt;/dev/null 2&gt;&amp;1; \</span><br><span class="line">	then echo 'i386-elf-'; \</span><br><span class="line">	elif objdump -i 2&gt;&amp;1 | grep 'elf32-i386' &gt;/dev/null 2&gt;&amp;1; \</span><br><span class="line">	then echo ''; \</span><br><span class="line">	<span class="keyword">else</span> echo <span class="string">"***"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** Error: Couldn't find an i386-elf version of GCC/binutils."</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** Is the directory with i386-elf-gcc in your PATH?"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** If your i386-elf toolchain is installed with a command"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** prefix other than 'i386-elf-', set your GCCPREFIX"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** environment variable to that prefix and run 'make' again."</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** To turn off this error, run 'gmake GCCPREFIX= ...'."</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"***"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; <span class="built_in">exit</span> <span class="number">1</span>; fi)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="meta"># try to infer the correct QEMU</span></span><br><span class="line">ifndef QEMU</span><br><span class="line">QEMU := $(shell <span class="keyword">if</span> which qemu-system-i386 &gt; /dev/null; \</span><br><span class="line">	then echo 'qemu-system-i386'; exit; \</span><br><span class="line">	elif which i386-elf-qemu &gt; /dev/null; \</span><br><span class="line">	then echo 'i386-elf-qemu'; exit; \</span><br><span class="line">	elif which qemu &gt; /dev/null; \</span><br><span class="line">	then echo 'qemu'; exit; \</span><br><span class="line">	<span class="keyword">else</span> \</span><br><span class="line">	echo <span class="string">"***"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** Error: Couldn't find a working QEMU executable."</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"*** Is the directory containing the qemu binary in your PATH"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; \</span><br><span class="line">	echo <span class="string">"***"</span> <span class="number">1</span>&gt;&amp;<span class="number">2</span>; <span class="built_in">exit</span> <span class="number">1</span>; fi)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="meta"># eliminate default suffix rules</span></span><br><span class="line">.SUFFIXES: .c .S .h</span><br><span class="line"></span><br><span class="line"><span class="meta"># delete target files <span class="meta-keyword">if</span> there is an <span class="meta-keyword">error</span> (or make is interrupted)</span></span><br><span class="line">.DELETE_ON_ERROR:</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> compiler and flags</span></span><br><span class="line">ifndef  USELLVM</span><br><span class="line">HOSTCC		:= gcc</span><br><span class="line">HOSTCFLAGS	:= -g -Wall -O2</span><br><span class="line">CC		:= $(GCCPREFIX)gcc</span><br><span class="line">CFLAGS	:= -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc $(DEFS)</span><br><span class="line">CFLAGS	+= $(shell $(CC) -fno-<span class="built_in">stack</span>-protector -E -x c /dev/null &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;&amp; echo -fno-<span class="built_in">stack</span>-protector)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">HOSTCC		:= clang</span><br><span class="line">HOSTCFLAGS	:= -g -Wall -O2</span><br><span class="line">CC		:= clang</span><br><span class="line">CFLAGS	:= -march=i686 -fno-builtin -fno-PIC -Wall -g -m32 -nostdinc $(DEFS)</span><br><span class="line">CFLAGS	+= $(shell $(CC) -fno-<span class="built_in">stack</span>-protector -E -x c /dev/null &gt;/dev/null <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;&amp; echo -fno-<span class="built_in">stack</span>-protector)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">CTYPE	:= c S</span><br><span class="line"></span><br><span class="line">LD      := $(GCCPREFIX)ld</span><br><span class="line">LDFLAGS	:= -m $(shell $(LD) -V | grep elf_i386 <span class="number">2</span>&gt;/dev/null | head -n <span class="number">1</span>)</span><br><span class="line">LDFLAGS	+= -nostdlib</span><br><span class="line"></span><br><span class="line">OBJCOPY := $(GCCPREFIX)objcopy</span><br><span class="line">OBJDUMP := $(GCCPREFIX)objdump</span><br><span class="line"></span><br><span class="line">COPY	:= cp</span><br><span class="line">MKDIR   := mkdir -p</span><br><span class="line">MV		:= mv</span><br><span class="line">RM		:= rm -f</span><br><span class="line">AWK		:= awk</span><br><span class="line">SED		:= sed</span><br><span class="line">SH		:= sh</span><br><span class="line">TR		:= tr</span><br><span class="line">TOUCH	:= touch -c</span><br><span class="line"></span><br><span class="line">OBJDIR	:= obj</span><br><span class="line">BINDIR	:= bin</span><br><span class="line"></span><br><span class="line">ALLOBJS	:=</span><br><span class="line">ALLDEPS	:=</span><br><span class="line">TARGETS	:=</span><br><span class="line"></span><br><span class="line">include tools/function.mk</span><br><span class="line"></span><br><span class="line">listf_cc = $(call listf,$(<span class="number">1</span>),$(CTYPE))</span><br><span class="line"></span><br><span class="line"># <span class="keyword">for</span> cc</span><br><span class="line">add_files_cc = $(call add_files,$(<span class="number">1</span>),$(CC),$(CFLAGS) $(<span class="number">3</span>),$(<span class="number">2</span>),$(<span class="number">4</span>))</span><br><span class="line">create_target_cc = $(call create_target,$(<span class="number">1</span>),$(<span class="number">2</span>),$(<span class="number">3</span>),$(CC),$(CFLAGS))</span><br><span class="line"></span><br><span class="line"># <span class="keyword">for</span> hostcc</span><br><span class="line">add_files_host = $(call add_files,$(<span class="number">1</span>),$(HOSTCC),$(HOSTCFLAGS),$(<span class="number">2</span>),$(<span class="number">3</span>))</span><br><span class="line">create_target_host = $(call create_target,$(<span class="number">1</span>),$(<span class="number">2</span>),$(<span class="number">3</span>),$(HOSTCC),$(HOSTCFLAGS))</span><br><span class="line"></span><br><span class="line">cgtype = $(patsubst %.$(<span class="number">2</span>),%.$(<span class="number">3</span>),$(<span class="number">1</span>))</span><br><span class="line">objfile = $(call toobj,$(<span class="number">1</span>))</span><br><span class="line">asmfile = $(call cgtype,$(call toobj,$(<span class="number">1</span>)),o,<span class="keyword">asm</span>)</span><br><span class="line">outfile = $(call cgtype,$(call toobj,$(<span class="number">1</span>)),o,out)</span><br><span class="line">symfile = $(call cgtype,$(call toobj,$(<span class="number">1</span>)),o,sym)</span><br><span class="line"></span><br><span class="line"># <span class="keyword">for</span> match pattern</span><br><span class="line">match = $(shell echo $(2) | $(AWK) '&#123;for(i=1;i&lt;=NF;i++)&#123;if(match("$(1)","^"$$(i)"$$"))&#123;exit 1;&#125;&#125;&#125;'; echo $$?)</span><br><span class="line"></span><br><span class="line"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> kernel/user</span></span><br><span class="line"></span><br><span class="line">INCLUDE	+= libs/</span><br><span class="line"></span><br><span class="line">CFLAGS	+= $(addprefix -I,$(INCLUDE))</span><br><span class="line"></span><br><span class="line">LIBDIR	+= libs</span><br><span class="line"></span><br><span class="line">$(call add_files_cc,$(call listf_cc,$(LIBDIR)),libs,)</span><br><span class="line"></span><br><span class="line"># -------------------------------------------------------------------</span><br><span class="line"># kernel</span><br><span class="line"></span><br><span class="line">KINCLUDE	+= kern/debug/ \</span><br><span class="line">			   kern/driver/ \</span><br><span class="line">			   kern/trap/ \</span><br><span class="line">			   kern/mm/</span><br><span class="line"></span><br><span class="line">KSRCDIR		+= kern/init \</span><br><span class="line">			   kern/libs \</span><br><span class="line">			   kern/debug \</span><br><span class="line">			   kern/driver \</span><br><span class="line">			   kern/trap \</span><br><span class="line">			   kern/mm</span><br><span class="line"></span><br><span class="line">KCFLAGS		+= $(addprefix -I,$(KINCLUDE))</span><br><span class="line"></span><br><span class="line">$(call add_files_cc,$(call listf_cc,$(KSRCDIR)),kernel,$(KCFLAGS))</span><br><span class="line"></span><br><span class="line">KOBJS	= $(call read_packet,kernel libs)</span><br><span class="line"></span><br><span class="line"># create kernel target</span><br><span class="line">kernel = $(call totarget,kernel)</span><br><span class="line"></span><br><span class="line">$(kernel): tools/kernel.ld</span><br><span class="line"></span><br><span class="line">$(kernel): $(KOBJS)</span><br><span class="line">	@echo + ld $@</span><br><span class="line">	$(V)$(LD) $(LDFLAGS) -T tools/kernel.ld -o $@ $(KOBJS)</span><br><span class="line">	@$(OBJDUMP) -S $@ &gt; $(call asmfile,kernel)</span><br><span class="line">	@$(OBJDUMP) -t $@ | $(SED) '1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d' &gt; $(call symfile,kernel)</span><br><span class="line"></span><br><span class="line">$(call create_target,kernel)</span><br><span class="line"></span><br><span class="line"># -------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta"># create bootblock</span></span><br><span class="line">bootfiles = $(call listf_cc,boot)</span><br><span class="line">$(foreach f,$(bootfiles),$(call cc_compile,$(f),$(CC),$(CFLAGS) -Os -nostdinc))</span><br><span class="line"></span><br><span class="line">bootblock = $(call totarget,bootblock)</span><br><span class="line"></span><br><span class="line">$(bootblock): $(call toobj,$(bootfiles)) | $(call totarget,sign)</span><br><span class="line">	@echo + ld $@</span><br><span class="line">	$(V)$(LD) $(LDFLAGS) -N -e start -Ttext <span class="number">0x7C00</span> $^ -o $(call toobj,bootblock)</span><br><span class="line">	@$(OBJDUMP) -S $(call objfile,bootblock) &gt; $(call asmfile,bootblock)</span><br><span class="line">	@$(OBJCOPY) -S -O binary $(call objfile,bootblock) $(call outfile,bootblock)</span><br><span class="line">	@$(call totarget,sign) $(call outfile,bootblock) $(bootblock)</span><br><span class="line"></span><br><span class="line">$(call create_target,bootblock)</span><br><span class="line"></span><br><span class="line"># -------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"># create 'sign' tools</span><br><span class="line">$(call add_files_host,tools/sign.c,sign,sign)</span><br><span class="line">$(call create_target_host,sign,sign)</span><br><span class="line"></span><br><span class="line"># -------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta"># create ucore.img</span></span><br><span class="line">UCOREIMG	:= $(call totarget,ucore.img)</span><br><span class="line"></span><br><span class="line">$(UCOREIMG): $(kernel) $(bootblock)</span><br><span class="line">	$(V)dd <span class="keyword">if</span>=/dev/zero of=$@ count=<span class="number">10000</span></span><br><span class="line">	$(V)dd <span class="keyword">if</span>=$(bootblock) of=$@ conv=notrunc</span><br><span class="line">	$(V)dd <span class="keyword">if</span>=$(kernel) of=$@ seek=<span class="number">1</span> conv=notrunc</span><br><span class="line"></span><br><span class="line">$(call create_target,ucore.img)</span><br><span class="line"></span><br><span class="line"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">$(call finish_all)</span><br><span class="line"></span><br><span class="line">IGNORE_ALLDEPS	= clean \</span><br><span class="line">				  dist-clean \</span><br><span class="line">				  grade \</span><br><span class="line">				  touch \</span><br><span class="line">				  print-.+ \</span><br><span class="line">				  handin</span><br><span class="line"></span><br><span class="line">ifeq ($(call match,$(MAKECMDGOALS),$(IGNORE_ALLDEPS)),<span class="number">0</span>)</span><br><span class="line">-include $(ALLDEPS)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"># files <span class="keyword">for</span> grade script</span><br><span class="line"></span><br><span class="line">TARGETS: $(TARGETS)</span><br><span class="line"></span><br><span class="line">.DEFAULT_GOAL := TARGETS</span><br><span class="line"></span><br><span class="line">.PHONY: qemu qemu-nox debug debug-nox</span><br><span class="line">qemu-mon: $(UCOREIMG)</span><br><span class="line">	$(V)$(QEMU)  -no-reboot -monitor stdio -hda $&lt; -serial null</span><br><span class="line">qemu: $(UCOREIMG)</span><br><span class="line">	$(V)$(QEMU) -no-reboot -parallel stdio -hda $&lt; -serial null</span><br><span class="line"><span class="built_in">log</span>: $(UCOREIMG)</span><br><span class="line">	$(V)$(QEMU) -no-reboot -d <span class="keyword">int</span>,cpu_reset  -D q.<span class="built_in">log</span> -parallel stdio -hda $&lt; -serial null</span><br><span class="line">qemu-nox: $(UCOREIMG)</span><br><span class="line">	$(V)$(QEMU)   -no-reboot -serial mon:stdio -hda $&lt; -nographic</span><br><span class="line">TERMINAL        :=gnome-terminal</span><br><span class="line">debug: $(UCOREIMG)</span><br><span class="line">	$(V)$(QEMU) -S -s -parallel stdio -hda $&lt; -serial null &amp;</span><br><span class="line">	$(V)sleep <span class="number">2</span></span><br><span class="line">	$(V)$(TERMINAL) -e <span class="string">"gdb -q -tui -x tools/gdbinit"</span></span><br><span class="line">	</span><br><span class="line">debug-nox: $(UCOREIMG)</span><br><span class="line">	$(V)$(QEMU) -S -s -serial mon:stdio -hda $&lt; -nographic &amp;</span><br><span class="line">	$(V)sleep <span class="number">2</span></span><br><span class="line">	$(V)$(TERMINAL) -e <span class="string">"gdb -q -x tools/gdbinit"</span></span><br><span class="line"></span><br><span class="line">.PHONY: grade touch</span><br><span class="line"></span><br><span class="line">GRADE_GDB_IN	:= .gdb.in</span><br><span class="line">GRADE_QEMU_OUT	:= .qemu.out</span><br><span class="line">HANDIN			:= proj$(PROJ)-handin.tar.gz</span><br><span class="line"></span><br><span class="line">TOUCH_FILES		:= kern/trap/trap.c</span><br><span class="line"></span><br><span class="line">MAKEOPTS		:= --quiet --no-print-directory</span><br><span class="line"></span><br><span class="line">grade:</span><br><span class="line">	$(V)$(MAKE) $(MAKEOPTS) clean</span><br><span class="line">	$(V)$(SH) tools/grade.sh</span><br><span class="line"></span><br><span class="line">touch:</span><br><span class="line">	$(V)$(foreach f,$(TOUCH_FILES),$(TOUCH) $(f))</span><br><span class="line"></span><br><span class="line">print-%:</span><br><span class="line">	@echo $($(shell echo $(patsubst print-%,%,$@) | $(TR) [a-z] [A-Z]))</span><br><span class="line"></span><br><span class="line">.PHONY: clean dist-clean handin packall tags</span><br><span class="line">clean:</span><br><span class="line">	$(V)$(RM) $(GRADE_GDB_IN) $(GRADE_QEMU_OUT) cscope* tags</span><br><span class="line">	-$(RM) -r $(OBJDIR) $(BINDIR)</span><br><span class="line"></span><br><span class="line">dist-clean: clean</span><br><span class="line">	-$(RM) $(HANDIN)</span><br><span class="line"></span><br><span class="line">handin: packall</span><br><span class="line">	@echo Please visit http:<span class="comment">//learn.tsinghua.edu.cn and upload $(HANDIN). Thanks!</span></span><br><span class="line"></span><br><span class="line">packall: clean</span><br><span class="line">	@$(RM) -f $(HANDIN)</span><br><span class="line">	@tar -czf $(HANDIN) `find . -type f -o -type d | grep -v '^\.*$$' | grep -vF '$(HANDIN)'`</span><br><span class="line"></span><br><span class="line">tags:</span><br><span class="line">	@echo TAGS ALL</span><br><span class="line">	$(V)rm -f cscope.files cscope.in.out cscope.out cscope.po.out tags</span><br><span class="line">	$(V)find . -type f -name <span class="string">"*.[chS]"</span> &gt;cscope.files</span><br><span class="line">	$(V)cscope -bq </span><br><span class="line">	$(V)ctags -L cscope.files</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用 make “V=” 命令查看具体操作，重定向到一个文本里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &quot;V=&quot; &gt; 1.txt</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>查看文本内容</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">+ cc kern/init/init.c</span><br><span class="line">gcc -Ikern/init/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/init/init.c -o obj/kern/init/init.o</span><br><span class="line">+ cc kern/libs/stdio.c</span><br><span class="line">gcc -Ikern/libs/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/libs/stdio.c -o obj/kern/libs/stdio.o</span><br><span class="line">+ cc kern/libs/readline.c</span><br><span class="line">gcc -Ikern/libs/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/libs/readline.c -o obj/kern/libs/readline.o</span><br><span class="line">+ cc kern/debug/panic.c</span><br><span class="line">gcc -Ikern/debug/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/debug/panic.c -o obj/kern/debug/panic.o</span><br><span class="line">+ cc kern/debug/kdebug.c</span><br><span class="line">gcc -Ikern/debug/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/debug/kdebug.c -o obj/kern/debug/kdebug.o</span><br><span class="line">+ cc kern/debug/kmonitor.c</span><br><span class="line">gcc -Ikern/debug/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/debug/kmonitor.c -o obj/kern/debug/kmonitor.o</span><br><span class="line">+ cc kern/driver/clock.c</span><br><span class="line">gcc -Ikern/driver/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/driver/clock.c -o obj/kern/driver/clock.o</span><br><span class="line">+ cc kern/driver/console.c</span><br><span class="line">gcc -Ikern/driver/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/driver/console.c -o obj/kern/driver/console.o</span><br><span class="line">+ cc kern/driver/picirq.c</span><br><span class="line">gcc -Ikern/driver/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/driver/picirq.c -o obj/kern/driver/picirq.o</span><br><span class="line">+ cc kern/driver/intr.c</span><br><span class="line">gcc -Ikern/driver/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/driver/intr.c -o obj/kern/driver/intr.o</span><br><span class="line">+ cc kern/trap/trap.c</span><br><span class="line">gcc -Ikern/trap/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/trap/trap.c -o obj/kern/trap/trap.o</span><br><span class="line">+ cc kern/trap/vectors.S</span><br><span class="line">gcc -Ikern/trap/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/trap/vectors.S -o obj/kern/trap/vectors.o</span><br><span class="line">+ cc kern/trap/trapentry.S</span><br><span class="line">gcc -Ikern/trap/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/trap/trapentry.S -o obj/kern/trap/trapentry.o</span><br><span class="line">+ cc kern/mm/pmm.c</span><br><span class="line">gcc -Ikern/mm/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/mm/pmm.c -o obj/kern/mm/pmm.o</span><br><span class="line">+ cc libs/<span class="built_in">string</span>.c</span><br><span class="line">gcc -Ilibs/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/  -c libs/<span class="built_in">string</span>.c -o obj/libs/<span class="built_in">string</span>.o</span><br><span class="line">+ cc libs/printfmt.c</span><br><span class="line">gcc -Ilibs/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/  -c libs/printfmt.c -o obj/libs/printfmt.o</span><br><span class="line">+ ld bin/kernel</span><br><span class="line">ld -m    elf_i386 -nostdlib -T tools/kernel.ld -o bin/kernel  obj/kern/init/init.o obj/kern/libs/stdio.o obj/kern/libs/readline.o obj/kern/debug/panic.o obj/kern/debug/kdebug.o obj/kern/debug/kmonitor.o obj/kern/driver/clock.o obj/kern/driver/console.o obj/kern/driver/picirq.o obj/kern/driver/intr.o obj/kern/trap/trap.o obj/kern/trap/vectors.o obj/kern/trap/trapentry.o obj/kern/mm/pmm.o  obj/libs/<span class="built_in">string</span>.o obj/libs/printfmt.o</span><br><span class="line">+ cc boot/bootasm.S</span><br><span class="line">gcc -Iboot/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Os -nostdinc -c boot/bootasm.S -o obj/boot/bootasm.o</span><br><span class="line">+ cc boot/bootmain.c</span><br><span class="line">gcc -Iboot/ -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc  -fno-<span class="built_in">stack</span>-protector -Ilibs/ -Os -nostdinc -c boot/bootmain.c -o obj/boot/bootmain.o</span><br><span class="line">+ cc tools/sign.c</span><br><span class="line">gcc -Itools/ -g -Wall -O2 -c tools/sign.c -o obj/sign/tools/sign.o</span><br><span class="line">gcc -g -Wall -O2 obj/sign/tools/sign.o -o bin/sign</span><br><span class="line">+ ld bin/bootblock</span><br><span class="line">ld -m    elf_i386 -nostdlib -N -e start -Ttext <span class="number">0x7C00</span> obj/boot/bootasm.o obj/boot/bootmain.o -o obj/bootblock.o</span><br><span class="line">'obj/bootblock.out' size: 484 bytes</span><br><span class="line">build 512 bytes boot sector: 'bin/bootblock' success!</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=bin/ucore.img count=<span class="number">10000</span></span><br><span class="line">dd <span class="keyword">if</span>=bin/bootblock of=bin/ucore.img conv=notrunc</span><br><span class="line">dd <span class="keyword">if</span>=bin/kernel of=bin/ucore.img seek=<span class="number">1</span> conv=notrunc</span><br></pre></td></tr></table></figure>
<blockquote>
<p>逐行解释一下<br>对于很多行前面都有+，这个是编译指令，多数UNIX平台都通过CC调用它们的C编译程序。比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ cc boot/bootmain.c</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>每一个上面的指令下面都是具体执行的shell命令，gcc就是使用gcc编译器编译，现在对于每一个参数进行分析</p>
<ul>
<li>-I（大写的i）   可指定查找include文件的其他位置.例如,如果有些include文件位于比较特殊的地方。</li>
<li>-Wall  以最高级别使用GNU编译程序,专门用于显示警告用!</li>
<li>-o 制定目标名称, 默认的时候, gcc 编译出来的文件是 a.out</li>
<li>-march 设置CPU类型，可以选择 i8086, i186, i286, i386, i486,等</li>
<li>g 生成gdb的调试信息</li>
<li>-fno-stack-protector 不生成栈溢出保护</li>
<li>-m32 编译生成32位程序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld -m    elf_i386 -nostdlib -N -e start -Ttext 0x7C00 obj/boot/bootasm.o obj/boot/bootmain.o -o obj/bootblock.o</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ld 通过运行C的编译器来运行链接程序生成</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=bin/kernel of=bin/ucore.img seek=1 conv=notrunc</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用指定大小拷贝一个文件</p>
</blockquote>
<h3 id="一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？"><a href="#一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？" class="headerlink" title="一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？"></a>一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？</h3><blockquote>
<p>查看sign.c文件内容<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: &lt;input filename&gt; &lt;output filename&gt;\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stat(argv[<span class="number">1</span>], &amp;st) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error opening file '%s': %s\n"</span>, argv[<span class="number">1</span>], strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"'%s' size: %lld bytes\n"</span>, argv[<span class="number">1</span>], (<span class="keyword">long</span> <span class="keyword">long</span>)st.st_size);</span><br><span class="line">    <span class="keyword">if</span> (st.st_size &gt; <span class="number">510</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%lld &gt;&gt; 510!!\n"</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)st.st_size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    FILE *ifp = fopen(argv[<span class="number">1</span>], <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">int</span> size = fread(buf, <span class="number">1</span>, st.st_size, ifp);</span><br><span class="line">    <span class="keyword">if</span> (size != st.st_size) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"read '%s' error, size is %d.\n"</span>, argv[<span class="number">1</span>], size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(ifp);</span><br><span class="line">    buf[<span class="number">510</span>] = <span class="number">0x55</span>;</span><br><span class="line">    buf[<span class="number">511</span>] = <span class="number">0xAA</span>;</span><br><span class="line">    FILE *ofp = fopen(argv[<span class="number">2</span>], <span class="string">"wb+"</span>);</span><br><span class="line">    size = fwrite(buf, <span class="number">1</span>, <span class="number">512</span>, ofp);</span><br><span class="line">    <span class="keyword">if</span> (size != <span class="number">512</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"write '%s' error, size is %d.\n"</span>, argv[<span class="number">2</span>], size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(ofp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"build 512 bytes boot sector: '%s' success!\n"</span>, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>查看细节的代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> size = fread(buf, <span class="number">1</span>, st.st_size, ifp);</span><br><span class="line">    <span class="keyword">if</span> (size != st.st_size) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"read '%s' error, size is %d.\n"</span>, argv[<span class="number">1</span>], size);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buf[<span class="number">510</span>] = <span class="number">0x55</span>;</span><br><span class="line">    buf[<span class="number">511</span>] = <span class="number">0xAA</span>;</span><br><span class="line">    FILE *ofp = fopen(argv[<span class="number">2</span>], <span class="string">"wb+"</span>);</span><br><span class="line">    size = fwrite(buf, <span class="number">1</span>, <span class="number">512</span>, ofp);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>一个磁盘主引导扇区只有512字节。且 第510个（倒数第二个）字节是0x55，第511个（倒数第一个）字节是0xAA。</p>
</blockquote>
<h2 id="练习2-使用qemu执行并调试lab1中的软件"><a href="#练习2-使用qemu执行并调试lab1中的软件" class="headerlink" title="练习2: 使用qemu执行并调试lab1中的软件"></a>练习2: 使用qemu执行并调试lab1中的软件</h2><h3 id="从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。"><a href="#从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。" class="headerlink" title="从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。"></a>从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd labcodes_answer/lab1_result/</span><br><span class="line">$ make lab1-mon</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/10/16/b7yPIsFYqDlnOtL.jpg" alt></p>
<h3 id="在初始化位置0x7c00设置实地址断点-测试断点正常"><a href="#在初始化位置0x7c00设置实地址断点-测试断点正常" class="headerlink" title="在初始化位置0x7c00设置实地址断点,测试断点正常"></a>在初始化位置0x7c00设置实地址断点,测试断点正常</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b *<span class="number">0x7c00</span></span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<h3 id="从0x7c00开始跟踪代码运行-将单步跟踪反汇编得到的代码与bootasm-S和-bootblock-asm进行比较"><a href="#从0x7c00开始跟踪代码运行-将单步跟踪反汇编得到的代码与bootasm-S和-bootblock-asm进行比较" class="headerlink" title="从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较"></a>从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较</h3><p><img src="https://i.loli.net/2019/10/16/DvVCL6azIOuksWe.jpg" alt></p>
<blockquote>
<p>可以发现代码是一样的</p>
</blockquote>
<h2 id="练习3：分析bootloader进入保护模式的过程"><a href="#练习3：分析bootloader进入保护模式的过程" class="headerlink" title="练习3：分析bootloader进入保护模式的过程"></a>练习3：分析bootloader进入保护模式的过程</h2><h3 id="实模式"><a href="#实模式" class="headerlink" title="实模式"></a>实模式</h3><blockquote>
<p>在bootloader接手BIOS的工作后，当前的PC系统处于实模式（16位模式）运行状态，在这种状态下软件可访问的物理内存空间不能超过1MB，且无法发挥Intel 80386以上级别的32位CPU的4GB内存管理能力。实模式将整个物理内存看成分段的区域，程序代码和数据位于不同区域，操作系统和用户程序并没有区别对待，而且每一个指针都是指向实际的物理地址。这样，用户程序的一个指针如果指向了操作系统区域或其他用户程序区域，并修改了内容，那么其后果就很可能是灾难性的。通过修改A20地址线可以完成从实模式到保护模式的转换。有关A20的进一步信息可参考附录“关于A20 Gate”。</p>
</blockquote>
<h2 id="保护模式"><a href="#保护模式" class="headerlink" title="保护模式"></a>保护模式</h2><blockquote>
<p>只有在保护模式下，80386的全部32根地址线有效，可寻址高达4G字节的线性地址空间和物理地址空间，可访问64TB（有2^ 14个段,每个段最大空间为2^32字节）的逻辑地址空间，可采用分段存储管理机制和分页存储管理机制。这不仅为存储共享和保护提供了硬件支持，而且为实现虚拟存储提供了硬件支持。通过提供4个特权级和完善的特权检查机制，既能实现资源共享又能保证代码数据的安全及任务的隔离。保护模式下，有两个段表：GDT（Global Descriptor Table）和LDT（Local Descriptor Table），每一张段表可以包含8192 (2^13)个描述符，因而最多可以同时存在2 * 2^13 = 2 ^ 14个段。虽然保护模式下可以有这么多段，逻辑地址空间看起来很大，但实际上段并不能扩展物理地址空间，很大程度上各个段的地址空间是相互重叠的。目前所谓的64TB（2^ (14+32)=2^ 46）逻辑地址空间是一个理论值，没有实际意义。在32位保护模式下，真正的物理空间仍然只有2^32字节那么大。</p>
</blockquote>
<h2 id="关于A20-Gate"><a href="#关于A20-Gate" class="headerlink" title="关于A20 Gate"></a>关于A20 Gate</h2><h2 id="分段存储管理机制"><a href="#分段存储管理机制" class="headerlink" title="分段存储管理机制"></a>分段存储管理机制</h2><blockquote>
<p>只有在保护模式下才能使用分段存储管理机制。分段机制将内存划分成以起始地址和长度限制这两个二维参数表示的内存块，这些内存块就称之为段（Segment）。编译器把源程序编译成执行程序时用到的代码段、数据段、堆和栈等概念在这里可以与段联系起来，二者在含义上是一致的。分段机涉及4个关键内容：逻辑地址、段描述符（描述段的属性）、段描述符表（包含多个段描述符的“数组”）、段选择子（段寄存器，用于定位段描述符表中表项的索引）。转换逻辑地址（Logical Address,应用程序员看到的地址）到物理地址（Physical Address, 实际的物理内存地址）分以下两步：<br>分段地址转换：CPU把逻辑地址（由段选择子selector和段偏移offset组成）中的段选择子的内容作为段描述符表的索引，找到表中对应的段描述符，然后把段描述符中保存的段基址加上段偏移值，形成线性地址（Linear Address）。如果不启动分页存储管理机制，则线性地址等于物理地址。分页地址转换，这一步中把线性地址转换为物理地址。（注意：这一步是可选的，由操作系统决定是否需要。在后续试验中会涉及。<br>上述转换过程对于应用程序员来说是不可见的。线性地址空间由一维的线性地址构成，线性地址空间和物理地址空间对等。线性地址32位长，线性地址空间容量为4G字节。分段地址转换的基本过程如下图所示。</p>
</blockquote>
<p><img src="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab1_figs/image002.png" alt></p>
<h2 id="段描述符"><a href="#段描述符" class="headerlink" title="段描述符"></a>段描述符</h2><blockquote>
<p>在分段存储管理机制的保护模式下，每个段由如下三个参数进行定义：段基地址(Base Address)、段界限(Limit)和段属性(Attributes)。在ucore中的kern/mm/mmu.h中的struct segdesc 数据结构中有具体的定义。<br>段基地址：规定线性地址空间中段的起始地址。在80386保护模式下，段基地址长32位。因为基地址长度与寻址地址的长度相同，所以任何一个段都可以从32位线性地址空间中的任何一个字节开始，而不象实方式下规定的边界必须被16整除。<br>段界限：规定段的大小。在80386保护模式下，段界限用20位表示，而且段界限可以是以字节为单位或以4K字节为单位。<br>段属性：确定段的各种性质。<br>段属性中的粒度位（Granularity），用符号G标记。G=0表示段界限以字节位位单位，20位的界限可表示的范围是1字节至1M字节，增量为1字节；G=1表示段界限以4K字节为单位，于是20位的界限可表示的范围是4K字节至4G字节，增量为4K字节。<br>类型（TYPE）：用于区别不同类型的描述符。可表示所描述的段是代码段还是数据段，所描述的段是否可读/写/执行，段的扩展方向等。<br>描述符特权级（Descriptor Privilege Level）（DPL）：用来实现保护机制。<br>段存在位（Segment-Present bit）：如果这一位为0，则此描述符为非法的，不能被用来实现地址转换。如果一个非法描述符被加载进一个段寄存器，处理器会立即产生异常。图5-4显示了当存在位为0时，描述符的格式。操作系统可以任意的使用被标识为可用（AVAILABLE）的位。<br>已访问位（Accessed bit）：当处理器访问该段（当一个指向该段描述符的选择子被加载进一个段寄存器）时，将自动设置访问位。操作系统可清除该位。</p>
</blockquote>
<h2 id="查看源码"><a href="#查看源码" class="headerlink" title="查看源码"></a>查看源码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit bootasm.S</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#start address should be 0:7c00, in real mode, the beginning address of the running bootloader</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>起始地址应为0：7c00，在实模式下，是正在运行的引导程序的起始地址</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start:</span><br><span class="line">.code16                                             <span class="comment"># Assemble for 16-bit mode</span></span><br><span class="line">    cli                                             <span class="comment"># Disable interrupts</span></span><br><span class="line">    cld                                             <span class="comment"># String operations increment</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>CLI 全称 Clear Interupt 屏蔽中断,CLD 全称 Clear Director 字行块传送方向从低地址到高地址</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set up the important data segment registers (DS, ES, SS).</span></span><br><span class="line">    xorw %ax, %ax                                   <span class="comment"># Segment number zero</span></span><br><span class="line">    movw %ax, %ds                                   <span class="comment"># -&gt; Data Segment</span></span><br><span class="line">    movw %ax, %es                                   <span class="comment"># -&gt; Extra Segment</span></span><br><span class="line">    movw %ax, %ss                                   <span class="comment"># -&gt; Stack Segment</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>数据段寄存器（DS，ES，SS）清零</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Enable A20:</span><br><span class="line">#  For backwards compatibility with the earliest PCs, physical</span><br><span class="line"><span class="meta">#  address <span class="meta-keyword">line</span> 20 is tied low, so that addresses higher than</span></span><br><span class="line">#  <span class="number">1</span>MB wrap around to zero by <span class="keyword">default</span>. This code undoes <span class="keyword">this</span>.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用A20：为了与最早的PC向后兼容，物理地址线20在低电平，因此地址高于1MB默认回零。 此代码撤消了此操作。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">seta20<span class="number">.1</span>:</span><br><span class="line">    inb $<span class="number">0x64</span>, %al                                  <span class="comment"># Wait for not busy(8042 input buffer empty).</span></span><br><span class="line">    testb $<span class="number">0x2</span>, %al</span><br><span class="line">    jnz seta20<span class="number">.1</span></span><br><span class="line"></span><br><span class="line">    movb $<span class="number">0xd1</span>, %al                                 <span class="comment"># 0xd1 -&gt; port 0x64</span></span><br><span class="line">    outb %al, $<span class="number">0x64</span>                                 <span class="comment"># 0xd1 means: write data to 8042's P2 port</span></span><br><span class="line"></span><br><span class="line">seta20<span class="number">.2</span>:</span><br><span class="line">    inb $<span class="number">0x64</span>, %al                                  <span class="comment"># Wait for not busy(8042 input buffer empty).</span></span><br><span class="line">    testb $<span class="number">0x2</span>, %al</span><br><span class="line">    jnz seta20<span class="number">.2</span></span><br><span class="line"></span><br><span class="line">    movb $<span class="number">0xdf</span>, %al                                 <span class="comment"># 0xdf -&gt; port 0x60</span></span><br><span class="line">    outb %al, $<span class="number">0x60</span>                                 <span class="comment"># 0xdf = 11011111, means set P2's A20 bit(the 1 bit) to 1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>inb指令是给al寄存器做一个输入，test指令本质上和and一样，但是会置位ZF标志位，test结果为0时，ZF会置为1。jnz为jump not zero也就是ZF为0。上面的代码含义为使用8042键盘控制器控制A20，这样为切换到保护模式做好准备，使得32位地址线全部可用。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movl %cr0, %eax</span><br><span class="line">orl $CR0_PE_ON, %eax</span><br><span class="line">movl %eax, %cr0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>进入保护模式，将CR0寄存器最低位PE置1</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.code32                                             <span class="comment"># Assemble for 32-bit mode</span></span><br><span class="line">protcseg:</span><br><span class="line">    <span class="comment"># Set up the protected-mode data segment registers</span></span><br><span class="line">    movw $PROT_MODE_DSEG, %ax                       <span class="comment"># Our data segment selector</span></span><br><span class="line">    movw %ax, %ds                                   <span class="comment"># -&gt; DS: Data Segment</span></span><br><span class="line">    movw %ax, %es                                   <span class="comment"># -&gt; ES: Extra Segment</span></span><br><span class="line">    movw %ax, %fs                                   <span class="comment"># -&gt; FS</span></span><br><span class="line">    movw %ax, %gs                                   <span class="comment"># -&gt; GS</span></span><br><span class="line">    movw %ax, %ss                                   <span class="comment"># -&gt; SS: Stack Segment</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set up the stack pointer and call into C. The stack region is from 0--start(0x7c00)</span></span><br><span class="line">    movl $<span class="number">0x0</span>, %ebp</span><br><span class="line">    movl $start, %esp</span><br><span class="line">	call bootmain</span><br></pre></td></tr></table></figure>
<blockquote>
<p>设置5个段寄存器与栈帧地址，进入bootmain继续执行</p>
</blockquote>
<h2 id="练习4：分析bootloader加载ELF格式的OS的过程"><a href="#练习4：分析bootloader加载ELF格式的OS的过程" class="headerlink" title="练习4：分析bootloader加载ELF格式的OS的过程"></a>练习4：分析bootloader加载ELF格式的OS的过程</h2><blockquote>
<p>阅读bootmain.c源码<br>这是一个简单的启动装载程序，唯一的工作就是启动来自第一个IDE硬盘的ELF内核映像。</p>
</blockquote>
<blockquote>
<p>磁盘布局<br>此程序（bootasm.S和bootmain.c）是引导加载程序.应该存储在磁盘的第一个扇区中。第二个扇区开始保存内核映像。内核映像必须为ELF格式。</p>
</blockquote>
<blockquote>
<p>启动步骤<br>当CPU启动时，它将BIOS加载到内存中并执行,BIOS初始化设备，中断例程集以及读取引导设备的第一个扇区（例如，硬盘驱动器）进入内存并跳转到它。假设此引导加载程序存储在该引导程序的第一个扇区中控制从bootasm.S开始-设置保护模式，和一个堆栈，然后运行C代码，然后调用bootmain（）该文件中的bootmain（）会接管，读取内核并跳转到该内核。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">readsect(<span class="keyword">void</span> *dst, <span class="keyword">uint32_t</span> secno) &#123;</span><br><span class="line">    <span class="comment">// wait for disk to be ready</span></span><br><span class="line">    waitdisk();</span><br><span class="line"></span><br><span class="line">    outb(<span class="number">0x1F2</span>, <span class="number">1</span>);                         <span class="comment">// count = 1</span></span><br><span class="line">    outb(<span class="number">0x1F3</span>, secno &amp; <span class="number">0xFF</span>);</span><br><span class="line">    outb(<span class="number">0x1F4</span>, (secno &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    outb(<span class="number">0x1F5</span>, (secno &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    outb(<span class="number">0x1F6</span>, ((secno &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xF</span>) | <span class="number">0xE0</span>);</span><br><span class="line">    outb(<span class="number">0x1F7</span>, <span class="number">0x20</span>);                      <span class="comment">// cmd 0x20 - read sectors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for disk to be ready</span></span><br><span class="line">    waitdisk();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read a sector</span></span><br><span class="line">    insl(<span class="number">0x1F0</span>, dst, SECTSIZE / <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在linux的驱动程序中，都会使用大量的outb、outw、inb、inw等等宏来訪问硬件或寄存器。outb()   I/O 上写入 8 位数据 ( 1 字节 )。inb()   I/O 上读入 8 位数据 ( 1 字节 )。</p>
</blockquote>
<h3 id="ELF文件格式"><a href="#ELF文件格式" class="headerlink" title="ELF文件格式"></a>ELF文件格式</h3><blockquote>
<p>ELF(Executable and linking format)文件格式是Linux系统下的一种常用目标文件(object file)格式，有三种主要类型:</p>
<ul>
<li>用于执行的可执行文件(executable file)，用于提供程序的进程映像，加载的内存执行。 这也是本实验的OS文件类型。</li>
<li>用于连接的可重定位文件(relocatable file)，可与其它目标文件一起创建可执行文件和共享目标文件。</li>
<li>共享目标文件(shared object file),连接器可将它与其它可重定位文件和共享目标文件连接成其它的目标文件，动态连接器又可将它与可执行文件和其它共享目标文件结合起来创建一个进程映像。</li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">elfhdr</span> &#123;</span></span><br><span class="line">  uint magic;  <span class="comment">// must equal ELF_MAGIC</span></span><br><span class="line">  uchar elf[<span class="number">12</span>];</span><br><span class="line">  ushort type;</span><br><span class="line">  ushort machine;</span><br><span class="line">  uint version;</span><br><span class="line">  uint entry;  <span class="comment">// 程序入口的虚拟地址</span></span><br><span class="line">  uint phoff;  <span class="comment">// program header 表的位置偏移</span></span><br><span class="line">  uint shoff;</span><br><span class="line">  uint flags;</span><br><span class="line">  ushort ehsize;</span><br><span class="line">  ushort phentsize;</span><br><span class="line">  ushort phnum; <span class="comment">//program header表中的入口数目</span></span><br><span class="line">  ushort shentsize;</span><br><span class="line">  ushort shnum;</span><br><span class="line">  ushort shstrndx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>program header描述与程序执行直接相关的目标文件结构信息，用来在文件中定位各个段的映像，同时包含其他一些用来为程序创建进程映像所必需的信息。可执行文件的程序头部是一个program header结构的数组， 每个结构描述了一个段或者系统准备程序执行所必需的其它信息。目标文件的 “段” 包含一个或者多个 “节区”（section） ，也就是“段内容（Segment Contents）” 。程序头部仅对于可执行文件和共享目标文件有意义。可执行目标文件在ELF头部的e_phentsize和e_phnum成员中给出其自身程序头部的大小。程序头部的数据结构如下表所示：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> &#123;</span></span><br><span class="line">  uint type;   <span class="comment">// 段类型</span></span><br><span class="line">  uint offset;  <span class="comment">// 段相对文件头的偏移值</span></span><br><span class="line">  uint va;     <span class="comment">// 段的第一个字节将被放到内存中的虚拟地址</span></span><br><span class="line">  uint pa;</span><br><span class="line">  uint filesz;</span><br><span class="line">  uint memsz;  <span class="comment">// 段在内存映像中占用的字节数</span></span><br><span class="line">  uint flags;</span><br><span class="line">  uint align;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="练习5：实现函数调用堆栈跟踪函数"><a href="#练习5：实现函数调用堆栈跟踪函数" class="headerlink" title="练习5：实现函数调用堆栈跟踪函数"></a>练习5：实现函数调用堆栈跟踪函数</h2><blockquote>
<p>read_eip() 函数定义在kdebug.c中：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __noinline <span class="keyword">uint32_t</span></span><br><span class="line">read_eip(<span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> eip;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"movl 4(%%ebp), %0"</span> : <span class="string">"=r"</span> (eip))</span></span>;</span><br><span class="line">    <span class="keyword">return</span> eip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>read_ebp() 函数定义在x86.h中：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uint32_t</span></span><br><span class="line">read_ebp(<span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ebp;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"movl %%ebp, %0"</span> : <span class="string">"=r"</span> (ebp))</span></span>;  <span class="comment">//内联汇编,读取edp寄存器的值到变量ebp</span></span><br><span class="line">    <span class="keyword">return</span> ebp;  <span class="comment">//返回ebp的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>执行make qume结果如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ebp:<span class="number">0x00007b38</span> eip:<span class="number">0x00100bf2</span> args:<span class="number">0x00010094</span> <span class="number">0x0010e950</span> <span class="number">0x00007b68</span> <span class="number">0x001000a2</span></span><br><span class="line">    kern/debug/kdebug.c:<span class="number">297</span>: print_stackframe+<span class="number">48</span></span><br><span class="line">ebp:<span class="number">0x00007b48</span> eip:<span class="number">0x00100f40</span> args:<span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x0010008d</span></span><br><span class="line">    kern/debug/kmonitor.c:<span class="number">125</span>: mon_backtrace+<span class="number">23</span></span><br><span class="line">ebp:<span class="number">0x00007b68</span> eip:<span class="number">0x001000a2</span> args:<span class="number">0x00000000</span> <span class="number">0x00007b90</span> <span class="number">0xffff0000</span> <span class="number">0x00007b94</span></span><br><span class="line">    kern/init/init.c:<span class="number">48</span>: grade_backtrace2+<span class="number">32</span></span><br><span class="line">ebp:<span class="number">0x00007b88</span> eip:<span class="number">0x001000d1</span> args:<span class="number">0x00000000</span> <span class="number">0xffff0000</span> <span class="number">0x00007bb4</span> <span class="number">0x001000e5</span></span><br><span class="line">    kern/init/init.c:<span class="number">53</span>: grade_backtrace1+<span class="number">37</span></span><br><span class="line">ebp:<span class="number">0x00007ba8</span> eip:<span class="number">0x001000f8</span> args:<span class="number">0x00000000</span> <span class="number">0x00100000</span> <span class="number">0xffff0000</span> <span class="number">0x00100109</span></span><br><span class="line">    kern/init/init.c:<span class="number">58</span>: grade_backtrace0+<span class="number">29</span></span><br><span class="line">ebp:<span class="number">0x00007bc8</span> eip:<span class="number">0x00100124</span> args:<span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x0010379c</span></span><br><span class="line">    kern/init/init.c:<span class="number">63</span>: grade_backtrace+<span class="number">37</span></span><br><span class="line">ebp:<span class="number">0x00007be8</span> eip:<span class="number">0x00100066</span> args:<span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00007c4f</span></span><br><span class="line">    kern/init/init.c:<span class="number">28</span>: kern_init+<span class="number">101</span></span><br><span class="line">ebp:<span class="number">0x00007bf8</span> eip:<span class="number">0x00007d6e</span> args:<span class="number">0xc031fcfa</span> <span class="number">0xc08ed88e</span> <span class="number">0x64e4d08e</span> <span class="number">0xfa7502a8</span></span><br><span class="line">    &lt;unknow&gt;: -- <span class="number">0x00007d6d</span> --</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="练习6：完善中断初始化和处理"><a href="#练习6：完善中断初始化和处理" class="headerlink" title="练习6：完善中断初始化和处理"></a>练习6：完善中断初始化和处理</h2><h3 id="中断与异常"><a href="#中断与异常" class="headerlink" title="中断与异常"></a>中断与异常</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><blockquote>
<p>操作系统需要对计算机系统中的各种外设进行管理，这就需要CPU和外设能够相互通信才行。一般外设的速度远慢于CPU的速度。如果让操作系统通过CPU“主动关心”外设的事件，即采用通常的轮询(polling)机制，则太浪费CPU资源了。所以需要操作系统和CPU能够一起提供某种机制，让外设在需要操作系统处理外设相关事件的时候，能够“主动通知”操作系统，即打断操作系统和应用的正常执行，让操作系统完成外设的相关处理，然后在恢复操作系统和应用的正常执行。在操作系统中，这种机制称为中断机制。中断机制给操作系统提供了处理意外情况的能力，同时它也是实现进程/线程抢占式调度的一个重要基石。但中断的引入导致了对操作系统的理解更加困难。</p>
</blockquote>
<h4 id="中断分类"><a href="#中断分类" class="headerlink" title="中断分类"></a>中断分类</h4><blockquote>
<p>在操作系统中，有三种特殊的中断事件。</p>
<ul>
<li>由CPU外部设备引起的外部事件如I/O中断、时钟中断、控制台中断等是异步产生的（即产生的时刻不确定），与CPU的执行无关，我们称之为异步中断(asynchronous interrupt)也称外部中断,简称中断(interrupt)。</li>
<li>而把在CPU执行指令期间检测到不正常的或非法的条件(如除零错、地址访问越界)所引起的内部事件称作同步中断(synchronous interrupt)，也称内部中断，简称异常(exception)。</li>
<li>把在程序中使用请求系统服务的系统调用而引发的事件，称作陷入中断(trap interrupt)，也称软中断(soft interrupt)，系统调用(system call)简称trap。</li>
</ul>
</blockquote>
<blockquote>
<p>当CPU收到中断或者异常的事件时，它会暂停执行当前的程序或任务，通过一定的机制跳转到负责处理这个信号的相关处理例程中，在完成对这个事件的处理后再跳回到刚才被打断的程序或任务中。中断向量和中断服务例程的对应关系主要是由IDT（中断描述符表）负责。操作系统在IDT中设置好各种中断向量对应的中断描述符，留待CPU在产生中断后查询对应中断服务例程的起始地址。而IDT本身的起始地址保存在idtr寄存器中。</p>
</blockquote>
<h4 id="IDT"><a href="#IDT" class="headerlink" title="IDT"></a>IDT</h4><blockquote>
<p>中断描述符表把每个中断或异常编号和一个指向中断服务例程的描述符联系起来。同GDT一样，IDT是一个8字节的描述符数组，但IDT的第一项可以包含一个描述符。CPU把中断（异常）号乘以8做为IDT的索引。IDT可以位于内存的任意位置，CPU通过IDT寄存器（IDTR）的内容来寻址IDT的起始地址。指令LIDT和SIDT用来操作IDTR。两条指令都有一个显示的操作数：一个6字节表示的内存地址。指令的含义如下：<br>LIDT（Load IDT Register）指令：使用一个包含线性地址基址和界限的内存操作数来加载IDT。操作系统创建IDT时需要执行它来设定IDT的起始地址。这条指令只能在特权级0执行。<br>SIDT（Store IDT Register）指令：拷贝IDTR的基址和界限部分到一个内存地址。这条指令可以在任意特权级执行。<br>IDT和IDTR寄存器的结构和关系如下图所示：</p>
</blockquote>
<p><img src="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab1_figs/image007.png" alt></p>
<h2 id="中断向量表中一个表项占多少字节？其中哪几位代表中断处理代码的入口？"><a href="#中断向量表中一个表项占多少字节？其中哪几位代表中断处理代码的入口？" class="headerlink" title="中断向量表中一个表项占多少字节？其中哪几位代表中断处理代码的入口？"></a>中断向量表中一个表项占多少字节？其中哪几位代表中断处理代码的入口？</h2><blockquote>
<p>中断向量表一个表项占用8字节，其中2-3字节是段选择子，0-1字节和6-7字节拼成位移， 两者联合便是中断处理程序的入口地址。</p>
</blockquote>
<h2 id="请编程完善kern-trap-trap-c中对中断向量表进行初始化的函数idt-init。"><a href="#请编程完善kern-trap-trap-c中对中断向量表进行初始化的函数idt-init。" class="headerlink" title="请编程完善kern/trap/trap.c中对中断向量表进行初始化的函数idt_init。"></a>请编程完善kern/trap/trap.c中对中断向量表进行初始化的函数idt_init。</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* idt_init - initialize IDT to each of the entry points in kern/trap/vectors.S */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">idt_init(<span class="keyword">void</span>) &#123;</span><br><span class="line">     <span class="comment">/* LAB1 YOUR CODE : STEP 2 */</span></span><br><span class="line">     <span class="comment">/* (1) Where are the entry addrs of each Interrupt Service Routine (ISR)?</span></span><br><span class="line"><span class="comment">      *     All ISR's entry addrs are stored in __vectors. where is uintptr_t __vectors[] ?</span></span><br><span class="line"><span class="comment">      *     __vectors[] is in kern/trap/vector.S which is produced by tools/vector.c</span></span><br><span class="line"><span class="comment">      *     (try "make" command in lab1, then you will find vector.S in kern/trap DIR)</span></span><br><span class="line"><span class="comment">      *     You can use  "extern uintptr_t __vectors[];" to define this extern variable which will be used later.</span></span><br><span class="line"><span class="comment">      * (2) Now you should setup the entries of ISR in Interrupt Description Table (IDT).</span></span><br><span class="line"><span class="comment">      *     Can you see idt[256] in this file? Yes, it's IDT! you can use SETGATE macro to setup each item of IDT</span></span><br><span class="line"><span class="comment">      * (3) After setup the contents of IDT, you will let CPU know where is the IDT by using 'lidt' instruction.</span></span><br><span class="line"><span class="comment">      *     You don't know the meaning of this instruction? just google it! and check the libs/x86.h to know more.</span></span><br><span class="line"><span class="comment">      *     Notice: the argument of lidt is idt_pd. try to find it!</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从注视（1）中可以看出来，使用extern uintptr_t <strong>vectors[ ]来定义uintptr_t </strong>vectors[ ]这个变量;</p>
</blockquote>
<blockquote>
<p>宏SETGATE定义<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SETGATE(gate, istrap, sel, off, dpl) &#123;            \</span></span><br><span class="line">    (gate).gd_off_15_0 = (<span class="keyword">uint32_t</span>)(off) &amp; <span class="number">0xffff</span>;        \</span><br><span class="line">    (gate).gd_ss = (sel);                                \</span><br><span class="line">    (gate).gd_args = <span class="number">0</span>;                                    \</span><br><span class="line">    (gate).gd_rsv1 = <span class="number">0</span>;                                    \</span><br><span class="line">    (gate).gd_type = (istrap) ? STS_TG32 : STS_IG32;    \</span><br><span class="line">    (gate).gd_s = <span class="number">0</span>;                                    \</span><br><span class="line">    (gate).gd_dpl = (dpl);                                \</span><br><span class="line">    (gate).gd_p = <span class="number">1</span>;                                    \</span><br><span class="line">    (gate).gd_off_31_16 = (<span class="keyword">uint32_t</span>)(off) &gt;&gt; <span class="number">16</span>;        \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETGATE(idt[i], <span class="number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在中断门描述符表中通过建立中断门描述符，其中存储了中断处理例程的代码段GD_KTEXT和偏移量__vectors[i]，特权级为DPL_KERNEL。这样通过查询idt[i]就可定位到中断服务例程的起始地址。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lidt(&amp;idt_pd);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>建立好中断门描述符表后，通过指令lidt把中断门描述符表的起始地址装入IDTR寄存器中，从而完成中段描述符表的初始化工作。</p>
</blockquote>
<blockquote>
<p>完整代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">uintptr_t</span> __vectors[];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(idt) / <span class="keyword">sizeof</span>(struct gatedesc); i ++) &#123;</span><br><span class="line">        SETGATE(idt[i], <span class="number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// set for switch from user to kernel</span></span><br><span class="line">    SETGATE(idt[T_SWITCH_TOK], <span class="number">0</span>, GD_KTEXT, __vectors[T_SWITCH_TOK], DPL_USER);</span><br><span class="line">	<span class="comment">// load the IDT</span></span><br><span class="line">    lidt(&amp;idt_pd);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="请编程完善trap-c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数"><a href="#请编程完善trap-c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数" class="headerlink" title="请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数"></a>请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数</h3><blockquote>
<p>定义变量：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> <span class="title">switchk2u</span>, *<span class="title">switchu2k</span>;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>结构体 trapframe<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pushregs</span> <span class="title">tf_regs</span>;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> tf_gs;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_padding0;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_fs;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_padding1;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_es;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_padding2;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_ds;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_padding3;</span><br><span class="line">    <span class="keyword">uint32_t</span> tf_trapno;</span><br><span class="line">    <span class="comment">/* below here defined by x86 hardware */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> tf_err;</span><br><span class="line">    <span class="keyword">uintptr_t</span> tf_eip;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_cs;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_padding4;</span><br><span class="line">    <span class="keyword">uint32_t</span> tf_eflags;</span><br><span class="line">    <span class="comment">/* below here only when crossing rings, such as from user to kernel */</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> tf_esp;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_ss;</span><br><span class="line">    <span class="keyword">uint16_t</span> tf_padding5;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>宏定义：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRQ_OFFSET                32    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRQ_TIMER                 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRQ_KBD                   1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IRQ_COM1                  4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T_SWITCH_TOU              120</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_CS        ((GD_UTEXT) | DPL_USER)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_DS        ((GD_UDATA) | DPL_USER)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_DS    ((GD_KDATA) | DPL_KERNEL)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TICK_NUM 100</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>print_ticks函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print_ticks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cprintf(<span class="string">"%d ticks\n"</span>,TICK_NUM);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG_GRADE</span></span><br><span class="line">    cprintf(<span class="string">"End of Test.\n"</span>);</span><br><span class="line">    panic(<span class="string">"EOT: kernel seems ok."</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>trap_dispatch函数的实现：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">trap_dispatch(struct trapframe *tf) &#123;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tf-&gt;tf_trapno) &#123;</span><br><span class="line">    <span class="keyword">case</span> IRQ_OFFSET + IRQ_TIMER:</span><br><span class="line">        ticks ++;</span><br><span class="line">        <span class="keyword">if</span> (ticks % TICK_NUM == <span class="number">0</span>) &#123;</span><br><span class="line">            print_ticks();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//下面的代码不用我们实现</span></span><br><span class="line">    <span class="keyword">case</span> IRQ_OFFSET + IRQ_COM1:</span><br><span class="line">        c = cons_getc();</span><br><span class="line">        cprintf(<span class="string">"serial [%03d] %c\n"</span>, c, c);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IRQ_OFFSET + IRQ_KBD:</span><br><span class="line">        c = cons_getc();</span><br><span class="line">        cprintf(<span class="string">"kbd [%03d] %c\n"</span>, c, c);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> T_SWITCH_TOU:</span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_cs != USER_CS) &#123;</span><br><span class="line">            switchk2u = *tf;</span><br><span class="line">            switchk2u.tf_cs = USER_CS;</span><br><span class="line">            switchk2u.tf_ds = switchk2u.tf_es = switchk2u.tf_ss = USER_DS;</span><br><span class="line">            switchk2u.tf_esp = (<span class="keyword">uint32_t</span>)tf + <span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">            switchk2u.tf_eflags |= FL_IOPL_MASK;</span><br><span class="line">            *((<span class="keyword">uint32_t</span> *)tf - <span class="number">1</span>) = (<span class="keyword">uint32_t</span>)&amp;switchk2u;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> T_SWITCH_TOK:</span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_cs != KERNEL_CS) &#123;</span><br><span class="line">            tf-&gt;tf_cs = KERNEL_CS;</span><br><span class="line">            tf-&gt;tf_ds = tf-&gt;tf_es = KERNEL_DS;</span><br><span class="line">            tf-&gt;tf_eflags &amp;= ~FL_IOPL_MASK;</span><br><span class="line">            switchu2k = (struct trapframe *)(tf-&gt;tf_esp - (<span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>));</span><br><span class="line">            memmove(switchu2k, tf, <span class="keyword">sizeof</span>(struct trapframe) - <span class="number">8</span>);</span><br><span class="line">            *((<span class="keyword">uint32_t</span> *)tf - <span class="number">1</span>) = (<span class="keyword">uint32_t</span>)switchu2k;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IRQ_OFFSET + IRQ_IDE1:</span><br><span class="line">    <span class="keyword">case</span> IRQ_OFFSET + IRQ_IDE2:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            print_trapframe(tf);</span><br><span class="line">            panic(<span class="string">"unexpected trap in kernel.\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt><br><img src alt></p>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="http://yoursite.com">HackPluto</a>
            </p><p>原文链接：<a href="http://yoursite.com/2019/10/14/ucore-lab0,lab1/">http://yoursite.com/2019/10/14/ucore-lab0,lab1/</a>
            </p><p>发表日期：<a href="http://yoursite.com/2019/10/14/ucore-lab0,lab1/">October 14th 2019, 8:28:18 am</a>
            </p><p>更新日期：<a href="http://yoursite.com/2019/10/14/ucore-lab0,lab1/">October 28th 2019, 9:24:33 pm</a>
            </p><p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2019/10/17/堆的分配原理分析/" title="堆的分配原理分析">
                    <div class="nextTitle">堆的分配原理分析</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2019/10/09/pwn-堆溢出/" title="PWN-堆溢出">
                    <div class="prevTitle">PWN-堆溢出</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:turing0day@gmail.com" class="iconfont-archer email" title="email"></a>
            
        
    
        
            
                <a href="https://github.com/HackPluto" class="iconfont-archer github" target="_blank" title="github"></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title="rss"></a>
            
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#lab0"><span class="toc-number">1.</span> <span class="toc-text">lab0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#make和makefile"><span class="toc-number">1.1.</span> <span class="toc-text">make和makefile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#makefile的规则"><span class="toc-number">1.1.1.</span> <span class="toc-text">makefile的规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于硬件模拟器实现源码级调试"><span class="toc-number">1.2.</span> <span class="toc-text">基于硬件模拟器实现源码级调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装硬件模拟器QEMU"><span class="toc-number">1.2.1.</span> <span class="toc-text">安装硬件模拟器QEMU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结合gdb和qemu源码级调试ucore"><span class="toc-number">1.2.2.</span> <span class="toc-text">结合gdb和qemu源码级调试ucore</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ucore-代码编译"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">ucore 代码编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用远程调试"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">使用远程调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用gdb配置文件"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">使用gdb配置文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab1"><span class="toc-number">2.</span> <span class="toc-text">lab1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#练习1：理解通过make生成执行文件的过程"><span class="toc-number">2.1.</span> <span class="toc-text">练习1：理解通过make生成执行文件的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#操作系统镜像文件ucore-img是如何一步一步生成的？"><span class="toc-number">2.1.1.</span> <span class="toc-text">操作系统镜像文件ucore.img是如何一步一步生成的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？"><span class="toc-number">2.1.2.</span> <span class="toc-text">一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#练习2-使用qemu执行并调试lab1中的软件"><span class="toc-number">2.2.</span> <span class="toc-text">练习2: 使用qemu执行并调试lab1中的软件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。"><span class="toc-number">2.2.1.</span> <span class="toc-text">从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在初始化位置0x7c00设置实地址断点-测试断点正常"><span class="toc-number">2.2.2.</span> <span class="toc-text">在初始化位置0x7c00设置实地址断点,测试断点正常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从0x7c00开始跟踪代码运行-将单步跟踪反汇编得到的代码与bootasm-S和-bootblock-asm进行比较"><span class="toc-number">2.2.3.</span> <span class="toc-text">从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#练习3：分析bootloader进入保护模式的过程"><span class="toc-number">2.3.</span> <span class="toc-text">练习3：分析bootloader进入保护模式的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实模式"><span class="toc-number">2.3.1.</span> <span class="toc-text">实模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#保护模式"><span class="toc-number">2.4.</span> <span class="toc-text">保护模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于A20-Gate"><span class="toc-number">2.5.</span> <span class="toc-text">关于A20 Gate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分段存储管理机制"><span class="toc-number">2.6.</span> <span class="toc-text">分段存储管理机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#段描述符"><span class="toc-number">2.7.</span> <span class="toc-text">段描述符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看源码"><span class="toc-number">2.8.</span> <span class="toc-text">查看源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#练习4：分析bootloader加载ELF格式的OS的过程"><span class="toc-number">2.9.</span> <span class="toc-text">练习4：分析bootloader加载ELF格式的OS的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ELF文件格式"><span class="toc-number">2.9.1.</span> <span class="toc-text">ELF文件格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#练习5：实现函数调用堆栈跟踪函数"><span class="toc-number">2.10.</span> <span class="toc-text">练习5：实现函数调用堆栈跟踪函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#练习6：完善中断初始化和处理"><span class="toc-number">2.11.</span> <span class="toc-text">练习6：完善中断初始化和处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#中断与异常"><span class="toc-number">2.11.1.</span> <span class="toc-text">中断与异常</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义"><span class="toc-number">2.11.1.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#中断分类"><span class="toc-number">2.11.1.2.</span> <span class="toc-text">中断分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IDT"><span class="toc-number">2.11.1.3.</span> <span class="toc-text">IDT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中断向量表中一个表项占多少字节？其中哪几位代表中断处理代码的入口？"><span class="toc-number">2.12.</span> <span class="toc-text">中断向量表中一个表项占多少字节？其中哪几位代表中断处理代码的入口？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#请编程完善kern-trap-trap-c中对中断向量表进行初始化的函数idt-init。"><span class="toc-number">2.13.</span> <span class="toc-text">请编程完善kern/trap/trap.c中对中断向量表进行初始化的函数idt_init。</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#请编程完善trap-c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数"><span class="toc-number">2.13.1.</span> <span class="toc-text">请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数</span></a></li></ol></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 34
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span><a class="archive-post-title" href="/2019/11/01/CCProxy栈溢出漏洞分析及利用/">CCProxy栈溢出漏洞分析及利用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/28</span><a class="archive-post-title" href="/2019/10/28/DirtyCow漏洞复现及原理分析/">DirtyCow漏洞复现及原理分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/28</span><a class="archive-post-title" href="/2019/10/28/树状数组/">树状数组</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/17</span><a class="archive-post-title" href="/2019/10/17/堆的分配原理分析/">堆的分配原理分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/14</span><a class="archive-post-title" href="/2019/10/14/ucore-lab0,lab1/">ucore_lab0,lab1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/09</span><a class="archive-post-title" href="/2019/10/09/pwn-堆溢出/">PWN-堆溢出</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/30</span><a class="archive-post-title" href="/2019/09/30/格式化字符串漏洞/">格式化字符串漏洞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/29</span><a class="archive-post-title" href="/2019/09/29/花式栈溢出技巧/">花式栈溢出技巧</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/27</span><a class="archive-post-title" href="/2019/09/27/看雪KCTF2019wp/">看雪KCTF2019wp</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/25</span><a class="archive-post-title" href="/2019/09/25/与权权的秦皇岛之行/">与权权的秦皇岛之行</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span><a class="archive-post-title" href="/2019/09/24/反静态调试总结/">反静态调试总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span><a class="archive-post-title" href="/2019/09/20/msf恶意代码免杀总结/">msf恶意代码免杀总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/01</span><a class="archive-post-title" href="/2019/09/01/windows后渗透维权/">windows后渗透维权</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/14</span><a class="archive-post-title" href="/2019/08/14/基于BROP的栈溢出漏洞利用/">基于BROP的栈溢出漏洞利用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/11</span><a class="archive-post-title" href="/2019/08/11/Linux动态链接库之GOT-PLT/">Linux动态链接库之GOT,PLT</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/09</span><a class="archive-post-title" href="/2019/08/09/ACM数论/">ACM数论</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/06</span><a class="archive-post-title" href="/2019/08/06/Traceme动态分析与静态分析/">Traceme动态分析与静态分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/01</span><a class="archive-post-title" href="/2019/08/01/Pwn-栈溢出与canary/">Pwn--栈溢出与绕过防护</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/01</span><a class="archive-post-title" href="/2019/08/01/SSH代理与端口转发/">SSH代理与端口转发</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/31</span><a class="archive-post-title" href="/2019/07/31/LAMP安装及配置/">LAMP安装及配置</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span><a class="archive-post-title" href="/2019/06/13/攻防世界逆向入门writeup/">攻防世界逆向入门writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/12</span><a class="archive-post-title" href="/2019/06/12/2019看雪CTF逆向Q1writeup/">2019看雪CTF逆向Q1writeup</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span><a class="archive-post-title" href="/2019/06/02/Linux下的iptables详解/">Linux下的iptables详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span><a class="archive-post-title" href="/2019/05/27/自己动手写工具(3)--ARP欺骗/">自己动手写工具(3)--ARP欺骗</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/22</span><a class="archive-post-title" href="/2019/05/22/素数个数求解与素数的判定/">素数个数求解与素数的判定</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/22</span><a class="archive-post-title" href="/2019/05/22/使用动态规划-DP-解决最大公共子串与最大公共子序列问题/">使用动态规划(DP)解决最大公共子串与最大公共子序列问题</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/10</span><a class="archive-post-title" href="/2019/05/10/自己动手写工具(2)--TCP代理/">自己动手写工具(2)--TCP代理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/10</span><a class="archive-post-title" href="/2019/05/10/CTF中的编码总结/">CTF中的编码总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span><a class="archive-post-title" href="/2019/04/28/一次信息收集之绕过CDN查询真实ip/">一次信息收集之绕过CDN查询真实ip</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/25</span><a class="archive-post-title" href="/2019/04/25/信息收集之DNS域名解析/">信息收集之DNS域名解析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/23</span><a class="archive-post-title" href="/2019/04/23/自己动手写工具(1)--Netcat/">自己动手写工具（1）--Netcat</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span><a class="archive-post-title" href="/2019/04/19/python下多核/">python下多核，单核CPU对于并行，并发执行效率的对比</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span><a class="archive-post-title" href="/2019/04/19/sqli-labs/">sqli-labs 通关详解</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/16</span><a class="archive-post-title" href="/2019/04/16/hello-world/">HackPluto's Blog</a>
        </li>
    
    </ul></div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="逆向,CTF"><span class="iconfont-archer">&#xe606;</span>逆向,CTF</span>
    
        <span class="sidebar-tag-name" data-tags="ACM,数论"><span class="iconfont-archer">&#xe606;</span>ACM,数论</span>
    
        <span class="sidebar-tag-name" data-tags="防火墙,iptables"><span class="iconfont-archer">&#xe606;</span>防火墙,iptables</span>
    
        <span class="sidebar-tag-name" data-tags="Linux,LAMP"><span class="iconfont-archer">&#xe606;</span>Linux,LAMP</span>
    
        <span class="sidebar-tag-name" data-tags="ctf,web,编码"><span class="iconfont-archer">&#xe606;</span>ctf,web,编码</span>
    
        <span class="sidebar-tag-name" data-tags="SSH,端口转发"><span class="iconfont-archer">&#xe606;</span>SSH,端口转发</span>
    
        <span class="sidebar-tag-name" data-tags="IDA,OllyDB"><span class="iconfont-archer">&#xe606;</span>IDA,OllyDB</span>
    
        <span class="sidebar-tag-name" data-tags="MSF,免杀"><span class="iconfont-archer">&#xe606;</span>MSF,免杀</span>
    
        <span class="sidebar-tag-name" data-tags="信息收集,社会工程学"><span class="iconfont-archer">&#xe606;</span>信息收集,社会工程学</span>
    
        <span class="sidebar-tag-name" data-tags="动态规划(DP)"><span class="iconfont-archer">&#xe606;</span>动态规划(DP)</span>
    
        <span class="sidebar-tag-name" data-tags="花指令,静态调试,Movfuscator"><span class="iconfont-archer">&#xe606;</span>花指令,静态调试,Movfuscator</span>
    
        <span class="sidebar-tag-name" data-tags="PWN,BROP,栈溢出"><span class="iconfont-archer">&#xe606;</span>PWN,BROP,栈溢出</span>
    
        <span class="sidebar-tag-name" data-tags="XCTF,逆向"><span class="iconfont-archer">&#xe606;</span>XCTF,逆向</span>
    
        <span class="sidebar-tag-name" data-tags="ACM,树状数组"><span class="iconfont-archer">&#xe606;</span>ACM,树状数组</span>
    
        <span class="sidebar-tag-name" data-tags="看雪,KCTF,逆向,PWN"><span class="iconfont-archer">&#xe606;</span>看雪,KCTF,逆向,PWN</span>
    
        <span class="sidebar-tag-name" data-tags="工具,python,Netcat"><span class="iconfont-archer">&#xe606;</span>工具,python,Netcat</span>
    
        <span class="sidebar-tag-name" data-tags="工具,python,proxy"><span class="iconfont-archer">&#xe606;</span>工具,python,proxy</span>
    
        <span class="sidebar-tag-name" data-tags="栈溢出,PWN"><span class="iconfont-archer">&#xe606;</span>栈溢出,PWN</span>
    
        <span class="sidebar-tag-name" data-tags="CCProxy,栈溢出,pwn"><span class="iconfont-archer">&#xe606;</span>CCProxy,栈溢出,pwn</span>
    
        <span class="sidebar-tag-name" data-tags="Linux,GOT,PLT"><span class="iconfont-archer">&#xe606;</span>Linux,GOT,PLT</span>
    
        <span class="sidebar-tag-name" data-tags="pwn,Heap"><span class="iconfont-archer">&#xe606;</span>pwn,Heap</span>
    
        <span class="sidebar-tag-name" data-tags="python,多线程"><span class="iconfont-archer">&#xe606;</span>python,多线程</span>
    
        <span class="sidebar-tag-name" data-tags="概率法求素数,算法"><span class="iconfont-archer">&#xe606;</span>概率法求素数,算法</span>
    
        <span class="sidebar-tag-name" data-tags="工具,python,arp_poison"><span class="iconfont-archer">&#xe606;</span>工具,python,arp_poison</span>
    
        <span class="sidebar-tag-name" data-tags="ctf,web,sql注入"><span class="iconfont-archer">&#xe606;</span>ctf,web,sql注入</span>
    
        <span class="sidebar-tag-name" data-tags="pwn,Format String Vulnerability"><span class="iconfont-archer">&#xe606;</span>pwn,Format String Vulnerability</span>
    
        <span class="sidebar-tag-name" data-tags="PWN,栈溢出"><span class="iconfont-archer">&#xe606;</span>PWN,栈溢出</span>
    
        <span class="sidebar-tag-name" data-tags="Linux,DirtyCow"><span class="iconfont-archer">&#xe606;</span>Linux,DirtyCow</span>
    
        <span class="sidebar-tag-name" data-tags="windows,影子账户"><span class="iconfont-archer">&#xe606;</span>windows,影子账户</span>
    
        <span class="sidebar-tag-name" data-tags="ucore,lab0,lab1"><span class="iconfont-archer">&#xe606;</span>ucore,lab0,lab1</span>
    
        <span class="sidebar-tag-name" data-tags="pwn,堆,glibc"><span class="iconfont-archer">&#xe606;</span>pwn,堆,glibc</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br>
    1、请确保node版本大于6.2<br>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="逆向"><span class="iconfont-archer">&#xe60a;</span>逆向</span>
    
        <span class="sidebar-category-name" data-categories="ACM"><span class="iconfont-archer">&#xe60a;</span>ACM</span>
    
        <span class="sidebar-category-name" data-categories="Linux"><span class="iconfont-archer">&#xe60a;</span>Linux</span>
    
        <span class="sidebar-category-name" data-categories="CTFweb"><span class="iconfont-archer">&#xe60a;</span>CTFweb</span>
    
        <span class="sidebar-category-name" data-categories="内网渗透"><span class="iconfont-archer">&#xe60a;</span>内网渗透</span>
    
        <span class="sidebar-category-name" data-categories="社工"><span class="iconfont-archer">&#xe60a;</span>社工</span>
    
        <span class="sidebar-category-name" data-categories="爱的日记"><span class="iconfont-archer">&#xe60a;</span>爱的日记</span>
    
        <span class="sidebar-category-name" data-categories="Pwn"><span class="iconfont-archer">&#xe60a;</span>Pwn</span>
    
        <span class="sidebar-category-name" data-categories="BlackHatTools"><span class="iconfont-archer">&#xe60a;</span>BlackHatTools</span>
    
        <span class="sidebar-category-name" data-categories="PWN"><span class="iconfont-archer">&#xe60a;</span>PWN</span>
    
        <span class="sidebar-category-name" data-categories="python"><span class="iconfont-archer">&#xe60a;</span>python</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "HackPluto"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


